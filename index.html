<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNESCO World Heritage Globe</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #f0f0f0;
      background-color: #0b1026;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    header {
      padding: 1.5rem 2rem 1rem;
      text-align: center;
      background: linear-gradient(135deg, rgba(18, 32, 73, 0.9), rgba(16, 61, 99, 0.8));
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      z-index: 1;
    }

    header h1 {
      margin: 0 0 0.5rem;
      font-size: 1.8rem;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      max-width: 720px;
      margin-inline: auto;
      line-height: 1.5;
      color: rgba(240, 240, 240, 0.85);
    }

    #globe-container {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    #globeViz {
      position: absolute;
      inset: 0;
    }

    #status {
      position: absolute;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.65rem 1rem;
      border-radius: 999px;
      background: rgba(11, 16, 38, 0.75);
      backdrop-filter: blur(6px);
      color: #f0f0f0;
      font-size: 0.9rem;
      display: flex;
      gap: 0.45rem;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    #status.visible {
      opacity: 1;
    }

    #status .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(240, 240, 240, 0.4);
      border-top-color: #00c6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .tooltip {
      position: absolute;
      max-width: 260px;
      padding: 0.85rem 1rem;
      background: rgba(6, 10, 30, 0.92);
      color: #f5f5f5;
      border-radius: 12px;
      pointer-events: none;
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(0, 198, 255, 0.25);
      font-size: 0.85rem;
      line-height: 1.4;
      opacity: 0;
      transform: translate(-50%, -10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2;
    }

    .tooltip.visible {
      opacity: 1;
      transform: translate(-50%, -16px);
    }

    .tooltip h2 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
      color: #00c6ff;
    }

    .tooltip p {
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>UNESCO World Heritage Globe</h1>
      <p>
        Jelajahi situs budaya dan alam dunia yang terdaftar sebagai Warisan Dunia UNESCO.
        Titik pada globe diambil langsung dari feed GeoRSS resmi UNESCO dan menampilkan lokasi dan nama situs.
      </p>
    </header>
    <div id="globe-container">
      <div id="globeViz"></div>
      <div id="status"><span class="spinner" aria-hidden="true"></span><span id="status-text">Memuat data UNESCO…</span></div>
      <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>
    </div>
  </div>

  <script src="https://unpkg.com/three@0.155.0/build/three.min.js" defer></script>
  <script src="https://unpkg.com/three-globe@2.31.1/dist/three-globe.min.js" defer></script>
  <script src="https://unpkg.com/three/examples/js/controls/OrbitControls.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      const tooltip = document.getElementById('tooltip');

      function showStatus(message, persist = false) {
        statusText.textContent = message;
        statusEl.classList.add('visible');
        if (!persist) {
          clearTimeout(showStatus.hideTimeout);
          showStatus.hideTimeout = setTimeout(() => statusEl.classList.remove('visible'), 3500);
        }
      }

      function hideStatus() {
        statusEl.classList.remove('visible');
      }

      function showTooltip({ x, y }, site) {
        tooltip.innerHTML = `<h2>${site.title}</h2><p>${site.region || ''}</p>`;
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
        tooltip.classList.add('visible');
        tooltip.setAttribute('aria-hidden', 'false');
      }

      function hideTooltip() {
        tooltip.classList.remove('visible');
        tooltip.setAttribute('aria-hidden', 'true');
      }

      const globeContainer = document.getElementById('globeViz');

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
      globeContainer.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 260);

      const globe = new ThreeGlobe()
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
        .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
        .pointAltitude(0.015)
        .pointRadius(0.35)
        .pointColor(() => '#00c6ff');

      scene.add(globe);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 3, 5);
      scene.add(ambientLight, directionalLight);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.minDistance = 120;
      controls.maxDistance = 400;

      function resizeRenderer() {
        const { clientWidth, clientHeight } = globeContainer;
        if (!clientWidth || !clientHeight) {
          return;
        }
        renderer.setSize(clientWidth, clientHeight);
        camera.aspect = clientWidth / clientHeight;
        camera.updateProjectionMatrix();
      }

      window.addEventListener('resize', resizeRenderer);

      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      let pointObjects = [];

      function onPointerMove(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        if (!pointObjects.length) {
          hideTooltip();
          return;
        }

        const intersects = raycaster.intersectObjects(pointObjects, false);
        if (intersects.length > 0) {
          const [{ object }] = intersects;
          const site = object.__data;
          const screenPosition = object.getWorldPosition(new THREE.Vector3()).project(camera);
          const x = (screenPosition.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
          const y = (-screenPosition.y * 0.5 + 0.5) * renderer.domElement.clientHeight;
          showTooltip({ x, y }, site);
        } else {
          hideTooltip();
        }
      }

      function onPointerLeave() {
        hideTooltip();
      }

      renderer.domElement.addEventListener('pointermove', onPointerMove);
      renderer.domElement.addEventListener('pointerleave', onPointerLeave);

      function animate() {
        controls.update();
        globe.rotation.y += 0.0009;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }

      resizeRenderer();
      animate();

      async function loadGeoRss() {
        showStatus('Mengunduh data GeoRSS UNESCO…', true);
        try {
          const response = await fetch('https://whc.unesco.org/en/list/georss/');
          if (!response.ok) {
            throw new Error(`Gagal memuat data (${response.status})`);
          }
          const xmlText = await response.text();
          const xml = new window.DOMParser().parseFromString(xmlText, 'text/xml');
          const itemNodes = Array.from(xml.getElementsByTagName('item'));
          const data = itemNodes
            .map((item) => {
              const title = item.getElementsByTagName('title')[0]?.textContent?.trim() ?? 'Tanpa judul';
              const region = item.getElementsByTagName('category')[0]?.textContent?.trim();
              const pointText = item.getElementsByTagName('georss:point')[0]?.textContent
                || item.getElementsByTagName('point')[0]?.textContent;
              let lat = null;
              let lng = null;
              if (pointText) {
                const [latStr, lngStr] = pointText.trim().split(/\s+/);
                lat = Number(latStr);
                lng = Number(lngStr);
              } else {
                const latNode = item.getElementsByTagName('geo:lat')[0];
                const lngNode = item.getElementsByTagName('geo:long')[0];
                if (latNode && lngNode) {
                  lat = Number(latNode.textContent);
                  lng = Number(lngNode.textContent);
                }
              }
              if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                return null;
              }
              return { lat, lng, title, region };
            })
            .filter(Boolean);

          if (!data.length) {
            throw new Error('Tidak ada data lokasi yang ditemukan.');
          }

          globe.pointsData(data);
          pointObjects = globe
            .pointsData()
            .map((d) => {
              if (d.__threeObj) {
                d.__threeObj.__data = d;
                return d.__threeObj;
              }
              return null;
            })
            .filter(Boolean);
          hideStatus();
          showStatus(`Berhasil memuat ${data.length} situs Warisan Dunia.`, false);
        } catch (error) {
          console.error(error);
          showStatus('Gagal memuat data UNESCO. Silakan coba lagi atau periksa koneksi Anda.', true);
        }
      }

      loadGeoRss();
    });
  </script>
</body>
</html>
